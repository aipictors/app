name: Mobile Build

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]
    tags: ["v*"]
  workflow_dispatch:
    inputs:
      environment:
        description: "Which dart_defines/*.json to use"
        type: choice
        required: true
        default: production
        options:
          - debug
          - develop
          - staging
          - production

concurrency:
  group: mobile-build-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  # Keep CI Flutter/Dart aligned with pubspec.yaml environment constraints.
  FLUTTER_VERSION: "3.38.4"
  BUILD_ENV: ${{ github.event.inputs.environment || 'production' }}

jobs:
  android:
    name: Android (apk+aab)
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"
          cache: gradle

      - uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: Flutter pub get
        run: flutter pub get

      - name: Build APK (release)
        run: flutter build apk --release --dart-define-from-file=dart_defines/${{ env.BUILD_ENV }}.json

      - name: Build App Bundle (release)
        run: flutter build appbundle --release --dart-define-from-file=dart_defines/${{ env.BUILD_ENV }}.json

      - name: Upload Android artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-${{ env.BUILD_ENV }}
          if-no-files-found: error
          retention-days: 14
          path: |
            build/app/outputs/flutter-apk/*.apk
            build/app/outputs/bundle/release/*.aab

  ios:
    name: iOS (no codesign)
    runs-on: macos-14
    timeout-minutes: 45

    steps:
      - uses: actions/checkout@v4

      - uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: Flutter pub get
        run: flutter pub get

      - name: Pod install
        run: cd ios && pod install

      - name: Build iOS (release, no codesign)
        run: flutter build ios --release --no-codesign --dart-define-from-file=dart_defines/${{ env.BUILD_ENV }}.json

      - name: Package .app
        run: |
          mkdir -p dist
          ditto -c -k --sequesterRsrc --keepParent build/ios/iphoneos/Runner.app dist/Runner-${{ env.BUILD_ENV }}.app.zip

      - name: Upload iOS artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-${{ env.BUILD_ENV }}
          if-no-files-found: error
          retention-days: 14
          path: dist/*.zip

  release:
    name: GitHub Release (attach artifacts)
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    needs: [android, ios]
    timeout-minutes: 10
    permissions:
      contents: write

    steps:
      - name: Download Android artifacts
        uses: actions/download-artifact@v4
        with:
          name: android-${{ env.BUILD_ENV }}
          path: dist/android

      - name: Download iOS artifacts
        uses: actions/download-artifact@v4
        with:
          name: ios-${{ env.BUILD_ENV }}
          path: dist/ios

      - name: Create GitHub Release and upload assets
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          files: |
            dist/android/**/*.apk
            dist/android/**/*.aab
            dist/ios/**/*.zip
